<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Smart GPS + Indoor Location Checker</title>
<style>
body { font-family: system-ui, "Segoe UI", Roboto, sans-serif; padding:18px; max-width:900px; margin:auto; }
h1 { font-size:20px; margin-bottom:8px; }
.card { border:1px solid #ddd; padding:14px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.05); margin-bottom:12px; }
button { background:#1473e6; color:white; padding:8px 12px; border:none; border-radius:6px; cursor:pointer; }
.small { font-size:13px; color:#555; margin-top:6px; }
.ok { color:green; font-weight:700; }
.no { color:red; font-weight:700; }
.loading { display:inline-block; width:16px; height:16px; border:2px solid rgba(255,255,255,0.3); border-radius:50%; border-top-color:#fff; animation:spin 1s linear infinite; margin-right:6px; vertical-align:middle; }
@keyframes spin { to { transform:rotate(360deg); } }
</style>
</head>
<body>

<h1>Smart School Location Checker</h1>

<div class="card">
  <div id="status">Ready ‚Äî ‚ÄúUse current location‚Äù ‡§¶‡§¨‡§æ‡§è‡§Å‡•§</div>
  <button id="useLocation"><span id="loadIcon" class="loading" style="display:none;"></span>üìç Use current location</button>
  <div id="coords" class="small"></div>
</div>

<div class="card">
  <strong>Results:</strong>
  <div id="result" class="small"></div>
</div>

<script>
const statusEl = document.getElementById('status');
const resultEl = document.getElementById('result');
const coordsEl = document.getElementById('coords');
const loadIcon = document.getElementById('loadIcon');

const centers = [
  { name: 'Sarasvati School', lat: 24.6832581, lon: 80.5419671, radius: 1 },
  { name: 'Government School', lat: 24.6835231, lon: 80.5439499, radius: 1 }
];

function haversineKm(lat1, lon1, lat2, lon2){
  const R=6371, toRad=d=>d*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

async function getDrivingDistance(lat1, lon1, lat2, lon2){
  const url = `https://routing.openstreetmap.de/routed-car/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=false`;
  try{
    const res = await fetch(url);
    const data = await res.json();
    if(data.code==="Ok") return data.routes[0].distance/1000;
    return haversineKm(lat1, lon1, lat2, lon2);
  }catch{
    return haversineKm(lat1, lon1, lat2, lon2);
  }
}

// --- Hybrid Location ---
document.getElementById('useLocation').addEventListener('click', ()=>{
  loadIcon.style.display='inline-block';
  statusEl.textContent='üì° GPS ‡§∏‡•á location ‡§≤‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à...';
  
  let gotLocation = false;
  
  // Primary: High accuracy GPS (5s)
  navigator.geolocation.getCurrentPosition(
    pos=>{
      gotLocation = true;
      const { latitude, longitude, accuracy } = pos.coords;
      loadIcon.style.display='none';
      statusEl.textContent=`‚úÖ GPS location (accuracy ¬±${accuracy.toFixed(1)}m)`;
      processLocation(latitude, longitude);
    },
    err=>{
      console.warn('GPS error:', err.message);
    },
    { enableHighAccuracy:true, timeout:5000 }
  );

  // Secondary: fallback after 5s (network/WiFi)
  setTimeout(async ()=>{
    if(!gotLocation){
      statusEl.textContent='üåê Indoor mode: Approximate location by network.';
      loadIcon.style.display='none';
      try{
        const res = await fetch('https://ipapi.co/json/');
        const data = await res.json();
        const lat = data.latitude;
        const lon = data.longitude;
        processLocation(lat, lon, true);
      }catch(e){
        statusEl.textContent='‚ùå Location unavailable (no network).';
      }
    }
  }, 5000);
});

async function processLocation(lat, lon, isApprox=false){
  coordsEl.textContent=`Latitude: ${lat.toFixed(6)}, Longitude: ${lon.toFixed(6)}${isApprox?' (approx)': ''}`;
  let resultText='';
  for(const c of centers){
    const dist = await getDrivingDistance(lat, lon, c.lat, c.lon);
    const d = dist < 1 ? `${(dist*1000).toFixed(0)} meters` : `${dist.toFixed(2)} km`;
    if(dist <= c.radius){
      resultText += `<div class="ok">‚úÖ ${c.name}: Inside (${d})</div>`;
    }else{
      resultText += `<div class="no">‚ùå ${c.name}: Outside (${d})</div>`;
    }
  }
  resultEl.innerHTML = resultText;
}
</script>
</body>
</html>
