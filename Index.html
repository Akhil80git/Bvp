<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>School Location Checker</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
:root{--blue:#1473e6;--green:#22a;--red:#dc3545;--muted:#555}
body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",sans-serif;padding:16px;max-width:980px;margin:auto}
h1{font-size:20px;margin:6px 0}
.card{border:1px solid #ddd;padding:12px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.03);margin-bottom:12px}
label{display:block;margin-top:8px;font-weight:600}
input[type=number]{width:100%;padding:6px;margin-top:4px;box-sizing:border-box;border-radius:6px;border:1px solid #ccc}
button{margin-top:6px;padding:8px 10px;border-radius:6px;border:0;cursor:pointer;background:var(--blue);color:#fff}
.small{font-size:13px;color:var(--muted);margin-top:6px}
.ok{color:green;font-weight:700}
.no{color:red;font-weight:700}
.row{display:flex;gap:8px;margin-top:6px;align-items:center}
.col{flex:1}
.center-button{background:var(--green)}
pre{background:#f7f7f7;padding:10px;border-radius:6px;overflow:auto;margin-top:8px}
#userCoords{margin-top:8px;font-weight:600;color:var(--blue)}
#insideSection{display:none;padding:28px;text-align:center;font-size:18px;border:2px solid var(--blue);border-radius:12px;margin-top:16px;background:#f0f8ff}
#insideSection span{display:block;margin-top:8px;font-size:15px;color:#000}

/* Accuracy */
#gpsAccuracy{margin-top:8px;font-size:13px;color:var(--muted);display:none}
.progress{height:6px;background:#f1f1f1;border-radius:3px;margin-top:8px;overflow:hidden}
.progress-bar{height:100%;background:var(--blue);border-radius:3px;width:0%;transition:width .4s}
.accuracy-info{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-top:4px}
.accuracy-high{color:green}
.accuracy-medium{color:orange}
.accuracy-low{color:red}
.loading{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s linear infinite;margin-right:6px;vertical-align:middle}
@keyframes spin{to{transform:rotate(360deg)}}

/* Map */
#mapContainer{display:none;height:400px;margin-top:12px;border-radius:8px;overflow:hidden;border:1px solid #ddd}
#mapToggle{background:#28a745;margin-top:8px}
#mapToggle.hide{background:var(--red)}
@media(max-width:600px){body{padding:10px}}
</style>
</head>
<body>
<div id="mainSection">
  <h1>School Location Checker</h1>

  <div class="card">
    <strong>Current / Manual Location:</strong>
    <div id="status" class="small">Ready ‚Äî "Use current location" ‡§¶‡§¨‡§æ‡§è‡§Å ‡§Ø‡§æ manual location set ‡§ï‡§∞‡•á‡§Ç‡•§</div>
    <button id="btnUseCurrent">
      <span id="gpsLoading" class="loading" style="display:none"></span>
      üìç Use current location (GPS)
    </button>
    <button id="btnManualSet">üñäÔ∏è Set Manual Location</button>

    <div id="gpsAccuracy">
      <div class="accuracy-info"><span>Accuracy:</span><span id="accuracyValue"></span></div>
      <div class="progress"><div id="accuracyBar" class="progress-bar"></div></div>
      <div class="accuracy-info"><span>Poor</span><span>Good</span><span>Excellent</span></div>
    </div>

    <div id="manualInputs" style="margin-top:10px">
      <label>Latitude:</label>
      <input type="number" id="manualLat" step="any" placeholder="e.g., 24.6832581">
      <label>Longitude:</label>
      <input type="number" id="manualLon" step="any" placeholder="e.g., 80.5419671">
    </div>
    <div id="manualStatus" class="small"></div>
    <div id="userCoords"></div>
  </div>

  <div class="card">
    <strong>School Locations (radius editable):</strong>
    <div id="centersContainer" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <strong>Results:</strong>
    <div id="searchResult" class="small" style="margin-top:6px"></div>
  </div>

  <div class="card">
    <strong>Live Map:</strong>
    <button id="mapToggle">üó∫Ô∏è Show Live Map</button>
    <div id="mapContainer"></div>
  </div>

  <div class="card">
    <strong>Debug:</strong>
    <pre id="debug">Ready.</pre>
  </div>
</div>

<div id="insideSection">
  <strong>‡§Ü‡§™ ‡§á‡§∏ school ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§π‡•à‡§Ç! üòä</strong>
  <span id="insideUser">User: </span>
  <span id="insideSchool1">Sarasvati School: </span>
  <span id="insideSchool2">Government School: </span>
  <span id="distanceUserSchool1">Driving Distance to Sarasvati School: </span>
  <span id="distanceUserSchool2">Driving Distance to Government School: </span>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ---------- Utilities ---------- */
function haversineKm(a,b,c,d){const R=6371;const toRad=e=>e*Math.PI/180;const dLat=toRad(c-a);const dLon=toRad(d-b);const aa=Math.sin(dLat/2)**2+Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dLon/2)**2;const cc=2*Math.atan2(Math.sqrt(aa),Math.sqrt(1-aa));return R*cc;}

async function getDrivingDistance(lat1,lon1,lat2,lon2){
  const url=`https://routing.openstreetmap.de/routed-car/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=false&steps=true`;
  try{
    const r=await fetch(url);
    if(!r.ok) throw new Error('Network');
    const d=await r.json();
    if(d.code==='Ok'&&d.routes&&d.routes.length) return d.routes[0].distance/1000;
    throw new Error('No route');
  }catch(e){
    console.error('driving error',e);
    return haversineKm(lat1,lon1,lat2,lon2);
  }
}

async function getRouteGeometry(lat1,lon1,lat2,lon2){
  const url=`https://routing.openstreetmap.de/routed-car/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=full&geometries=geojson`;
  try{
    const r=await fetch(url);
    if(!r.ok) throw new Error('Network');
    const d=await r.json();
    if(d.code==='Ok'&&d.routes&&d.routes.length) return d.routes[0].geometry;
    throw new Error('No route');
  }catch(e){
    console.error('route geometry error',e);
    return null;
  }
}

/* ---------- DOM Refs ---------- */
const statusEl=document.getElementById('status'), manualStatus=document.getElementById('manualStatus');
const centersContainer=document.getElementById('centersContainer');
const btnUseCurrent=document.getElementById('btnUseCurrent'), btnManualSet=document.getElementById('btnManualSet');
const searchResultEl=document.getElementById('searchResult'), debugEl=document.getElementById('debug');
const userCoordsEl=document.getElementById('userCoords'), insideSection=document.getElementById('insideSection');
const insideUser=document.getElementById('insideUser'), insideSchool1=document.getElementById('insideSchool1');
const insideSchool2=document.getElementById('insideSchool2'), distanceUserSchool1=document.getElementById('distanceUserSchool1');
const distanceUserSchool2=document.getElementById('distanceUserSchool2');
const gpsLoadingEl=document.getElementById('gpsLoading'), gpsAccuracyEl=document.getElementById('gpsAccuracy');
const accuracyValueEl=document.getElementById('accuracyValue'), accuracyBarEl=document.getElementById('accuracyBar');
const mapContainer=document.getElementById('mapContainer'), mapToggle=document.getElementById('mapToggle');

let userLat=null,userLon=null,watchId=null,bestAccuracy=Infinity,bestCoords=null;
let map=null,userMarker=null,schoolMarkers=[],routeLayers=[],liveTracking=false,mapWatchId=null;

/* ---------- Centers ---------- */
let centers=[
  {name:'Sarasvati School',lat:24.6832581,lon:80.5419671,radius:1},
  {name:'Government School',lat:24.6835231,lon:80.5439499,radius:1}
];

function renderCenters(){
  centersContainer.innerHTML='';
  centers.forEach((c,i)=>{
    const row=document.createElement('div');row.className='row';
    row.innerHTML=`<div class="col"><strong>${c.name}</strong></div>
      <div class="col"><input type="number" step="0.1" data-index="${i}" class="centerRadius" value="${c.radius}" placeholder="Radius (km)"></div>
      <div class="col"><button class="center-button" data-index="${i}">Check</button></div>`;
    centersContainer.appendChild(row);
  });
  document.querySelectorAll('.center-button').forEach(btn=>{
    btn.addEventListener('click',async ()=>{
      const idx=+btn.getAttribute('data-index'); updateCentersFromInput();
      if(userLat==null||userLon==null){alert('Please set current or manual location first.');return;}
      await checkInside(userLat,userLon,centers[idx]);
    });
  });
}
function updateCentersFromInput(){document.querySelectorAll('.centerRadius').forEach(inp=>{const idx=+inp.getAttribute('data-index');const val=parseFloat(inp.value);if(!isNaN(val))centers[idx].radius=val;});}
renderCenters();

/* ---------- Map ---------- */
function initMap(){
  if(map) return;
  map=L.map('mapContainer').setView([24.6832581,80.5419671],15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
  centers.forEach(center=>{
    const m=L.marker([center.lat,center.lon]).addTo(map).bindPopup(`<b>${center.name}</b><br>Radius: ${center.radius} km`);
    schoolMarkers.push(m);
    L.circle([center.lat,center.lon],{color:'blue',fillColor:'#3388ff',fillOpacity:0.08,radius:center.radius*1000}).addTo(map);
  });
}

function updateUserMarker(lat,lon,accuracy){
  if(!map) return;
  if(userMarker){map.removeLayer(userMarker);}
  userMarker=L.marker([lat,lon]).addTo(map).bindPopup(`<b>Your Location</b><br>Lat: ${lat.toFixed(6)}<br>Lon: ${lon.toFixed(6)}`).openPopup();
  if(accuracy){L.circle([lat,lon],{color:'red',fillColor:'#f03',fillOpacity:0.15,radius:accuracy}).addTo(map);}
  const bounds=L.latLngBounds([[lat,lon]]);
  schoolMarkers.forEach(m=>bounds.extend(m.getLatLng()));
  map.fitBounds(bounds,{padding:[20,20]});
}

async function updateRoutes(lat,lon){
  if(!map) return;
  routeLayers.forEach(l=>map.removeLayer(l)); routeLayers=[];
  for(let i=0;i<centers.length;i++){
    const g=await getRouteGeometry(lat,lon,centers[i].lat,centers[i].lon);
    if(g){const layer=L.geoJSON(g,{style:{color:'red',weight:4,opacity:0.7}}).addTo(map);routeLayers.push(layer);}
  }
}

function toggleMap(){
  if(mapContainer.style.display==='none'){mapContainer.style.display='block';mapToggle.textContent='üó∫Ô∏è Hide Live Map';mapToggle.classList.add('hide');if(!map) initMap(); if(userLat&&userLon){updateUserMarker(userLat,userLon,bestAccuracy);updateRoutes(userLat,userLon);} if(liveTracking) startMapTracking();}
  else{mapContainer.style.display='none';mapToggle.textContent='üó∫Ô∏è Show Live Map';mapToggle.classList.remove('hide'); if(mapWatchId!==null){navigator.geolocation.clearWatch(mapWatchId);mapWatchId=null;}}
}

function startMapTracking(){
  if(!navigator.geolocation||!map) return;
  if(mapWatchId!==null) navigator.geolocation.clearWatch(mapWatchId);
  mapWatchId=navigator.geolocation.watchPosition(pos=>{
    const lat=pos.coords.latitude, lon=pos.coords.longitude, accuracy=pos.coords.accuracy;
    updateUserMarker(lat,lon,accuracy);
    updateRoutes(lat,lon);
    userCoordsEl.textContent=`Latitude: ${lat.toFixed(6)}, Longitude: ${lon.toFixed(6)}`;
  },err=>console.error('Map tracking error:',err),{enableHighAccuracy:true,maximumAge:10000,timeout:15000});
}

/* ---------- GPS 5s Optimized ---------- */
btnUseCurrent.addEventListener('click',()=>{
  statusEl.textContent='üì° GPS ‡§∏‡•á location ‡§≤‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à...'; gpsLoadingEl.style.display='inline-block'; gpsAccuracyEl.style.display='block';
  if(!navigator.geolocation){statusEl.textContent='‚ùå Browser geolocation supported ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ manual location set ‡§ï‡§∞‡•á‡§Ç‡•§';gpsLoadingEl.style.display='none';highlightManual();return;}
  if(watchId!==null) navigator.geolocation.clearWatch(watchId);
  bestAccuracy=Infinity; bestCoords=null;
  watchId=navigator.geolocation.watchPosition(pos=>{
    const accuracy=pos.coords.accuracy;
    if(accuracy<bestAccuracy){bestAccuracy=accuracy;bestCoords={latitude:pos.coords.latitude,longitude:pos.coords.longitude,accuracy}};
    accuracyValueEl.textContent=`¬±${accuracy.toFixed(1)} meters`;accuracyValueEl.className='';
    if(accuracy<=3){accuracyValueEl.classList.add('accuracy-high');accuracyBarEl.style.width='100%';}
    else if(accuracy<=10){accuracyValueEl.classList.add('accuracy-medium');accuracyBarEl.style.width='80%';}
    else{accuracyValueEl.classList.add('accuracy-low');accuracyBarEl.style.width='50%';}
  },err=>{statusEl.textContent='‚ùå GPS error: '+err.message+' ‚Äî ‡§ï‡•É‡§™‡§Ø‡§æ manual location set ‡§ï‡§∞‡•á‡§Ç‡•§';gpsLoadingEl.style.display='none';highlightManual();},{enableHighAccuracy:true,timeout:5000,maximumAge:0});
  setTimeout(()=>{if(watchId!==null){navigator.geolocation.clearWatch(watchId);watchId=null;gpsLoadingEl.style.display='none';if(bestCoords){userLat=bestCoords.latitude;userLon=bestCoords.longitude;statusEl.textContent='‚úÖ GPS location set (5s optimized).';accuracyValueEl.textContent=`¬±${bestAccuracy.toFixed(1)} meters`;userCoordsEl.textContent=`Latitude: ${userLat.toFixed(6)}, Longitude: ${userLon.toFixed(6)}`;debugEl.textContent=`Final coords: ${userLat}, ${userLon}, Accuracy: ${bestAccuracy.toFixed(1)}m`;liveTracking=true; if(mapContainer.style.display!=='none'){updateUserMarker(userLat,userLon,bestAccuracy);updateRoutes(userLat,userLon);startMapTracking();}}else{statusEl.textContent='‚ùå 5 seconds ‡§Æ‡•á‡§Ç location ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ manual set ‡§ï‡§∞‡•á‡§Ç‡•§';highlightManual();}}},5000);
});

/* ---------- Manual ---------- */
btnManualSet.addEventListener('click',()=>{
  const lat=parseFloat(document.getElementById('manualLat').value), lon=parseFloat(document.getElementById('manualLon').value);
  if(isNaN(lat)||isNaN(lon)){manualStatus.textContent='‚ùå Invalid input!'; return;}
  userLat=lat; userLon=lon; manualStatus.textContent='‚úÖ Manual location set ‡§π‡•ã ‡§ó‡§à‡•§'; statusEl.textContent='‚úÖ Manual location set.'; userCoordsEl.textContent=`Latitude: ${userLat.toFixed(6)}, Longitude: ${userLon.toFixed(6)}`; debugEl.textContent=`User coords: ${userLat}, ${userLon}`; gpsAccuracyEl.style.display='none'; liveTracking=false;
  if(mapContainer.style.display!=='none'){updateUserMarker(userLat,userLon);updateRoutes(userLat,userLon);}
});

/* ---------- Highlight manual ---------- */
function highlightManual(){document.getElementById('manualInputs').style.border='2px dashed red';manualStatus.textContent='üëâ GPS fail ‡§π‡•Å‡§Ü, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ø‡§π‡§æ‡§Ç Latitude ‡§î‡§∞ Longitude ‡§°‡§æ‡§≤‡•á‡§Ç‡•§';window.scrollTo({top:document.getElementById('manualInputs').offsetTop-20,behavior:'smooth'});}

/* ---------- Check Inside ---------- */
async function checkInside(lat,lon,center){
  const dist=await getDrivingDistance(lat,lon,center.lat,center.lon);
  const formatDistance=d=>d<1?`${(d*1000).toFixed(0)} meters`:`${d.toFixed(2)} km`;
  const inside=dist<=center.radius; const msg=`Driving Distance to ${center.name}: ${formatDistance(dist)}`;
  if(inside){
    searchResultEl.innerHTML=`<div class="ok">‚úÖ ${msg} ‚Üí ‡§Ö‡§Ç‡§¶‡§∞ ‡§π‡•à (within ${center.radius} km)</div>`;
    insideUser.textContent=`User: Latitude ${lat.toFixed(6)}, Longitude ${lon.toFixed(6)}`;
    insideSchool1.textContent=`Sarasvati School: Latitude ${centers[0].lat.toFixed(6)}, Longitude ${centers[0].lon.toFixed(6)}`;
    insideSchool2.textContent=`Government School: Latitude ${centers[1].lat.toFixed(6)}, Longitude ${centers[1].lon.toFixed(6)}`;
    const dist1=await getDrivingDistance(lat,lon,centers[0].lat,centers[0].lon);
    const dist2=await getDrivingDistance(lat,lon,centers[1].lat,centers[1].lon);
    distanceUserSchool1.textContent=`Driving Distance to Sarasvati School: ${formatDistance(dist1)}`;
    distanceUserSchool2.textContent=`Driving Distance to Government School: ${formatDistance(dist2)}`;
    insideSection.style.display='block'; insideSection.scrollIntoView({behavior:'smooth'});
  } else {
    searchResultEl.innerHTML=`<div class="no">‚ùå ${msg} ‚Üí ‡§¨‡§æ‡§π‡§∞ ‡§π‡•à (beyond ${center.radius} km)</div>`;
    insideSection.style.display='none';
  }
  debugEl.textContent=`Debug: ${JSON.stringify({lat,lon,center},null,2)}`;
}

/* ---------- Map toggle ---------- */
mapToggle.addEventListener('click',toggleMap);
</script>
</body>
</html>
